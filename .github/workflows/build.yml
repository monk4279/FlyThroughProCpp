name: Build QGIS Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        # os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - uses: actions/checkout@v4

    # --- Linux Setup ---
    - name: Install Dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qgis-dev \
          qtbase5-dev \
          qttools5-dev \
          libqt5svg5-dev \
          qt3d5-dev \
          cmake \
          build-essential

    # --- Windows Setup ---
    - name: Install Qt (Windows)
      if: runner.os == 'Windows'
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'

    - name: Install QGIS 3.28.3 (Windows)
      if: runner.os == 'Windows'
      run: |
        choco install qgis -y --version 3.28.3
        refreshenv
        echo "Searching for QGIS..."
        dir "C:\Program Files\QGIS*" /s /b
      shell: cmd

    # --- macOS Setup (via Micromamba) ---
    - name: Setup Micromamba (macOS)
      if: runner.os == 'macOS'
      uses: mamba-org/setup-micromamba@v1
      with:
        environment-name: qgis-dev
        create-args: >-
          qgis
          qt-main
          compilers
          cmake
          pkg-config
        init-shell: bash 

    - name: Build (macOS)
      if: runner.os == 'macOS'
      shell: bash -l {0}
      run: |
        mkdir build
        cd build
        cmake .. \
          -DCMAKE_PREFIX_PATH=$CONDA_PREFIX \
          -DQGIS_DIR=$CONDA_PREFIX \
          -DQt5_DIR=$CONDA_PREFIX/lib/cmake/Qt5
        cmake --build . --config Release

    # --- Build Step (Linux) ---
    - name: Build (Linux)
      if: runner.os == 'Linux'
      run: |
        mkdir build
        cd build
        cmake ..
        cmake --build . --config Release

    # --- Upload Artifacts ---
    - name: Upload Plugin
      uses: actions/upload-artifact@v4
      with:
        name: QGIS-Plugin-${{ runner.os }}
        path: build/**/libflythrough_pro_cpp.*
