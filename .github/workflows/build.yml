name: Build QGIS Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build on Windows
    runs-on: windows-latest
 
    steps:
    - uses: actions/checkout@v4

    # --- Setup OSGeo4W with QGIS Development Tools ---
    - name: Setup OSGeo4W
      uses: echoix/setup-OSGeo4W@v1
      with:
        packages: >
          qgis-dev
          qt5-devel
          cmake
          ninja

    # --- Build Step (Windows with OSGeo4W) ---
    - name: Build QGIS Plugin
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        set PATH=%OSGEO4W_ROOT%\bin;%PATH%
        mkdir build
        cd build
        cmake .. -G "Ninja" ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DCMAKE_PREFIX_PATH="%OSGEO4W_ROOT%" ^
          -DQGIS_INCLUDE_DIR="%OSGEO4W_ROOT%\apps\qgis-dev\include" ^
          -DQGIS_LIBRARY_DIR="%OSGEO4W_ROOT%\apps\qgis-dev\lib"
        cmake --build . --config Release

    # --- Upload Artifacts ---
    - name: Upload Plugin
      uses: actions/upload-artifact@v4
      with:
        name: QGIS-Plugin-Windows
        path: |
          build/flythrough_pro_cpp.dll
          build/flythrough_pro_cpp.lib
          build/flythrough_pro_cpp.exp
