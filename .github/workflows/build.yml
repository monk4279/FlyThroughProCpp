name: Build QGIS Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
 
    steps:
    - uses: actions/checkout@v4

    # --- Linux Setup ---
    - name: Install Dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qgis-dev \
          qtbase5-dev \
          qttools5-dev \
          libqt5svg5-dev \
          cmake \
          build-essential

    # --- Windows Setup (via Micromamba) ---
    - name: Setup Micromamba (Windows)
      if: runner.os == 'Windows'
      uses: mamba-org/setup-micromamba@v1
      with:
        environment-name: qgis-dev
        create-args: >-
          qgis=3.28.3
          qt-main
          compilers
          cmake
          pkg-config
          ninja
        init-shell: cmd.exe

    # --- macOS Setup (via Micromamba) ---
    - name: Setup Micromamba (macOS)
      if: runner.os == 'macOS'
      uses: mamba-org/setup-micromamba@v1
      with:
        environment-name: qgis-dev
        create-args: >-
          qgis
          qt-main
          compilers
          cmake
          pkg-config
        init-shell: bash 

    - name: Build (macOS)
      if: runner.os == 'macOS'
      shell: bash -l {0}
      run: |
        mkdir build
        cd build
        cmake .. \
          -DCMAKE_PREFIX_PATH=$CONDA_PREFIX \
          -DQGIS_DIR=$CONDA_PREFIX \
          -DQt5_DIR=$CONDA_PREFIX/lib/cmake/Qt5
        cmake --build . --config Release

    # --- Build Step (Windows) ---
    - name: Build (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        call micromamba activate qgis-dev
        mkdir build
        cd build
        cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="%CONDA_PREFIX%" -DQGIS_DIR="%CONDA_PREFIX%" -DQt5_DIR="%CONDA_PREFIX%/Library/lib/cmake/Qt5"
        cmake --build . --config Release

    # --- Build Step (Linux) ---
    - name: Build (Linux)
      if: runner.os == 'Linux'
      run: |
        mkdir build
        cd build
        cmake ..
        cmake --build . --config Release

    # --- Upload Artifacts ---
    - name: Upload Plugin
      uses: actions/upload-artifact@v4
      with:
        name: QGIS-Plugin-${{ runner.os }}
        path: build/libflythrough_pro_cpp.* 
