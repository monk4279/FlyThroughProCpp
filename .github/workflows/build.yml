name: Build QGIS Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build on Windows (QGIS 3.28.3)
    runs-on: windows-latest
 
    steps:
    - uses: actions/checkout@v4

    # --- Setup OSGeo4W with QGIS Development Tools ---
    - name: Install OSGeo4W and QGIS 3.28
      shell: cmd
      timeout-minutes: 15
      run: |
        curl -L -o osgeo4w-setup.exe http://download.osgeo.org/osgeo4w/v2/osgeo4w-setup.exe
        osgeo4w-setup.exe ^
          --quiet-mode ^
          --no-desktop ^
          --only-site ^
          --autoaccept ^
          --root C:\OSGeo4W ^
          --site http://download.osgeo.org/osgeo4w/v2 ^
          --packages qgis-ltr-dev,qt5-devel,cmake,ninja
        
    - name: Wait for Installation to Complete
      shell: pwsh
      run: Start-Sleep -Seconds 30
      
    - name: Verify QGIS Installation
      shell: cmd
      run: |
        set OSGEO4W_ROOT=C:\OSGeo4W
        echo Checking QGIS installation...
        dir "%OSGEO4W_ROOT%\apps\qgis-ltr-dev"
        if exist "%OSGEO4W_ROOT%\apps\qgis-ltr-dev\bin\qgis.exe" (
          echo QGIS LTR Dev found!
          "%OSGEO4W_ROOT%\apps\qgis-ltr-dev\bin\qgis.exe" --version
        ) else (
          echo QGIS executable not found, but dev files should be present
          echo Continuing with build...
        )

    - name: Debug QGIS Installation Structure  
      shell: cmd
      run: |
        echo === Checking QGIS Dev Installation ===
        dir C:\OSGeo4W\apps\qgis-ltr-dev
        echo.
        echo === Include Directory ===
        dir C:\OSGeo4W\apps\qgis-ltr-dev\include
        echo.
        echo === Lib Directory ===
        dir C:\OSGeo4W\apps\qgis-ltr-dev\lib
        echo.
        echo === Bin Directory ===
        dir C:\OSGeo4W\apps\qgis-ltr-dev\bin

    # --- Build Step (Windows with OSGeo4W) ---
    - name: Build QGIS Plugin
      shell: cmd
      run: |
        set OSGEO4W_ROOT=C:\OSGeo4W
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        set PATH=%OSGEO4W_ROOT%\bin;%PATH%
        
        mkdir build
        cd build
        
        cmake .. -G "Ninja" ^
          -DCMAKE_BUILD_TYPE=Release ^
          -DCMAKE_PREFIX_PATH="%OSGEO4W_ROOT%" ^
          -DQGIS_INCLUDE_DIR="%OSGEO4W_ROOT%\apps\qgis-ltr-dev\include" ^
          -DQGIS_LIBRARY_DIR="%OSGEO4W_ROOT%\apps\qgis-ltr-dev\lib" ^
          -DQt5_DIR="%OSGEO4W_ROOT%\apps\Qt5\lib\cmake\Qt5"
          
        cmake --build . --config Release

    # --- Upload Artifacts ---
    - name: Upload Plugin
      uses: actions/upload-artifact@v4
      with:
        name: QGIS-Plugin-Windows-3.28
        path: |
          build/flythrough_pro_cpp.dll
          build/flythrough_pro_cpp.lib
          build/flythrough_pro_cpp.exp
