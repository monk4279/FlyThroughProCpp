name: Build QGIS Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest]
 
    steps:
    - uses: actions/checkout@v4

    # --- Windows Setup (via Micromamba) ---
    - name: Setup Micromamba (Windows)
      if: runner.os == 'Windows'
      uses: mamba-org/setup-micromamba@v1
      with:
        environment-name: qgis-dev
        create-args: >-
          qgis=3.28.3
          qt-main
          compilers
          cmake
          pkg-config
          ninja
        init-shell: cmd.exe

    # --- Build Step (Windows) ---
    - name: Build (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        echo mkdir build > build.bat
        echo cd build >> build.bat
        echo cmake .. -G "Ninja" -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="%%CONDA_PREFIX%%" -DQGIS_DIR="%%CONDA_PREFIX%%" -DQt5_DIR="%%CONDA_PREFIX%%/Library/lib/cmake/Qt5" >> build.bat
        echo cmake --build . --config Release >> build.bat
        echo cmake --build . --config Release >> build.bat
        micromamba run -n qgis-dev build.bat
    
    # --- Debug Dependencies ---
    - name: Inspect Dependencies (Windows)
      if: runner.os == 'Windows'
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        dumpbin /dependents build\flythrough_pro_cpp.dll

    # --- Upload Artifacts ---
    - name: Upload Plugin
      uses: actions/upload-artifact@v4
      with:
        name: QGIS-Plugin-${{ runner.os }}
        path: |
          build/flythrough_pro_cpp.dll
          build/flythrough_pro_cpp.lib
          build/flythrough_pro_cpp.exp
